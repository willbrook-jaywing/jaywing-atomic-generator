//-------------------------------------------------------
//  Generator: Components
//-------------------------------------------------------

var _generator = require('yeoman-generator');
var _inquirer = require('inquirer');
var _fs = require('fs');
var _path = require('path');
var _ = require('lodash');
var _config = require('../config');

var _templateFilePrefix = 'component.template';
var _templateFileExtensions = ['.njk', '.scss', '.definition.scss', '.size.scss', '.js'];
var _docsTemplateDataFile = _config.app.path + _config.app.pathDocsTemplateData + _config.app.fileDocsTemplateData;
var _pathSass = _config.app.path + _config.components.pathSass;
var _pathJs = _config.app.path + _config.components.pathJs;
var _pathTemplate = _config.app.path + _config.components.pathTemplate;
var _filePrefix = _config.components.filePrefix;
var _cssTempColor = _config.components.cssTempColor;
var _cssTempBackground = _config.components.cssTempBackground;
var _cssTempPadding = _config.components.cssTempPadding;

var _action = null;
var _category = null;
var _categoryPath = null;
var _name = null;
var _namePath = null;
var _cssClassName = null;
var _jsClassName = null;
var _description = null;
var _createModule = null;
var _sizes = null;
var _sizeNames = null;
var _sizeIncludeNames = null;
var _sizeCssClassNames = null;
var _names = null;

var _promptActionObj = {type: 'list', name: 'action', message: 'Action:', choices: ['Add', 'Delete', new _inquirer.Separator(), 'Back']};
var _promptCategoryObj = {type: 'list', name: 'category', message: 'Category:', choices: ['Defaults', 'Objects', 'Elements', 'Navigation', 'Common']};
var _promptNameObj = {type: 'input', name: 'name', message : 'Name:'};
var _promptDescriptionObj = {type: 'input', name: 'description', message : 'Description:', default: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.'};
var _promptModuleActionObj = {type: 'list', name: 'moduleAction', message: 'JS Module:', choices: ['Create New', 'Use Existing', 'None']};
var _promptModuleNamesObj = {type: 'list', name: 'moduleName', message: 'Modules:', choices: []};
var _promptSizesObj = {type: 'checkbox', name: 'sizes', message : 'Sizes:', choices: [{name: 'Xxs', value: 'Xxs', checked: true}, {name: 'Xs', value: 'Xs', checked: true}, {name: 'Sm', value: 'Sm', checked: true}, {name: 'Md', value: 'Md', checked: true}, {name: 'Lg', value: 'Lg', checked: true}, {name: 'Xl', value: 'Xl', checked: true}, {name: 'Xxl', value: 'Xxl', checked: true}]};
var _promptNamesObj = {type: 'checkbox', name: 'name', message: 'Components:', choices: []};
var _promptAddObj = {type: 'list', name: 'add', message : 'All OK?', choices: ['Yes', 'No']};
var _promptDeleteObj = {type: 'list', name: 'delete', message : 'Are you sure?', choices: ['Yes', 'No']};

var baseExtension = {

  prompting: function () {
    this._promptAction();
  },

  _promptAction: function () {
    return this.prompt(_promptActionObj).then(function (answers) {
      _action = answers.action;
      _action == 'Back' ? this.composeWith('jaywing-atomic:app') : this._promptCategory();
    }.bind(this));
  },

  _promptCategory: function () {
    return this.prompt(_promptCategoryObj).then(function (answers) {
      _category = answers.category;
      _categoryPath = _category.toLowerCase();
      _action == 'Add' ? this._promptName() : this._promptNames();
    }.bind(this));
  },

  _promptName: function () {
    _promptNameObj.validate = this._validateName;
    return this.prompt(_promptNameObj).then(function (answers) {
      _name = this._getName(answers.name);
      _namePath = this._getNamePath(answers.name);
      _cssClassName = _category == 'Objects' ? 'o-' + this._getCssClassName(answers.name) : this._getCssClassName(answers.name);
      this._promptDescription();
    }.bind(this));
  },

  _promptDescription: function () {
    return this.prompt(_promptDescriptionObj).then(function (answers) {
      _description = answers.description;
      this._promptModuleAction();
    }.bind(this));
  },

  _promptModuleAction: function () {
    return this.prompt(_promptModuleActionObj).then(function (answers) {

      _jsClassName = null;

      switch(answers.moduleAction) {
        case 'Create New':
          _createModule = true;
          _jsClassName = this._getJsClassName(_name);
          this._promptSizes();
          break;
        case 'Use Existing':
          this._promptModuleNames();
          break;
        case 'None':
          this._promptSizes();
          break;
      }

    }.bind(this));
  },

  _promptModuleNames: function () {
    var path = _pathJs;
    var exists = _fs.existsSync(path);
    if(exists) {
      var readList = _fs.readdirSync(path);
      var names = [];
      for(var i = 0; i < readList.length; i++) {
        var strs = readList[i].split('.');
        var name = strs[0];
        names.push(name);
      }
      _promptModuleNamesObj.choices = names;
      return this.prompt(_promptModuleNamesObj).then(function (answers) {
        _jsClassName = answers.moduleName;
        this._promptSizes();
      }.bind(this));
    } else {
      this.log('  No modules found');
      this._promptModuleAction();
    }
  },

  _promptSizes: function () {
    return this.prompt(_promptSizesObj).then(function (answers) {
      _sizes = answers.sizes;
      _sizeNames = [];
      _sizeIncludeNames = [];
      _sizeCssClassNames = [];
      for(var i = 0; i < _sizes.length; i++) {
        _sizeNames.push(_name + ' ' + _sizes[i]);
        _sizeIncludeNames.push(_sizes[i].toLowerCase());
        _sizeCssClassNames.push(_cssClassName + _sizes[i]);
      }
      this._promptAdd();
    }.bind(this));
  },

  _promptNames: function () {
    var path = _pathSass + _categoryPath;
    var exists = _fs.existsSync(path);
    if(exists) {
      var readList = _fs.readdirSync(path);
      var names = [];
      for(var i = 0; i < readList.length; i++) {
        var name = this._getName(readList[i]);
        names.push(name);
      }
      _promptNamesObj.choices = names;
      return this.prompt(_promptNamesObj).then(function (answers) {
        _names = [];
        for(var i = 0; i < answers.name.length; i++) {
          _names.push(answers.name[i]);
        }
        this._promptDelete();
      }.bind(this));
    } else {
      this.log('  No components in that category found');
      this.composeWith('jaywing-atomic:app');
    }
  },

  _promptAdd: function () {
    this._logDetails();
    return this.prompt(_promptAddObj).then(function (answers) {
      answers.add == 'Yes' ? this._add() : this.composeWith('jaywing-atomic:app');
    }.bind(this));
  },

  _promptDelete: function () {
    return this.prompt(_promptDeleteObj).then(function (answers) {

      if(answers.delete == 'Yes') {
        for (var i = 0; i < _names.length; i++) {
          this._delete(_names[i]);
        }
      } else {
        this.composeWith('jaywing-atomic:app');
      }

    }.bind(this));
  },

  _logDetails: function () {
    this.log('  -------------- Component ---------------');
    this.log('       Name: ' + _name);
    this.log('        Css: ' + _cssClassName);
    if(_sizes.length > 0) {
      var sizes = '';
      var sizeCssClassNames = '';
      for (var i = 0; i < _sizes.length; i++) {
        sizes += _sizes[i] + ' ';
        sizeCssClassNames += _sizeCssClassNames[i] + ' ';
      }
      sizes.trim();
      sizeCssClassNames.trim();
      this.log('      Sizes: ' + sizes);
      this.log('  Sizes Css: ' + sizeCssClassNames);
    } else {
      this.log('      Sizes: None');
      this.log('  Sizes Css: N/A');
    }
    _createModule ? this.log('         JS: ' + _jsClassName) : this.log('         JS: None');
    this.log('  ----------------------------------------');
  },

  _add: function () {

    var data = {};
    data.name = _name;
    data.htmlClassName = _cssClassName;
    for (var i = 0; i < _sizes.length; i++) {
      data.htmlClassName += ' ' + _sizeCssClassNames[i];
    }
    data.cssClassName = _cssClassName;
    data.sassVarPrefix = _namePath;
    data.cssTempColor = _cssTempColor;
    data.cssTempBackground = _cssTempBackground;
    data.cssTempPadding = _cssTempPadding;
    data.jsClassName = _jsClassName;
    data.description = _description;
    data.pageId = _namePath;
    var dataModuleAttr = _jsClassName ? ' data-module=\"' + _jsClassName + '\"' : '';
    data.exampleHtml = '<div class=\"' + data.htmlClassName + '\"' + dataModuleAttr + '>\n\n\t\t\t<h4>' + _name + '</h4>\n\n\t\t</div>';
    data.codeHtml = '<div class=\"' + data.htmlClassName + '\"' + dataModuleAttr + '>\n\n\t\t\t\t\t<h4>' + _name + '</h4>\n\n\t\t\t\t</div>';

    var sassImports = [];
    var fileExtensions = _createModule ? _templateFileExtensions : _templateFileExtensions.slice(0, -1);

    // Add to docs data
    var docsTemplateDataFileObj = JSON.parse(_fs.readFileSync(_docsTemplateDataFile, 'utf8'));
    var docsPageItemObj = {};
    docsPageItemObj.id = _namePath;
    docsPageItemObj.title = _name;
    docsPageItemObj.section = "components";
    docsPageItemObj.ready = true;

    // Find corresponding page object
    var docsPagesObj = docsTemplateDataFileObj.docs_pages;
    var docsPageObjFound = false;
    for (var p = 0; p < docsPagesObj.length; p++) {
      var docsPageObj = docsPagesObj[p];
      if (docsPageObj.category == _category && docsPageObj.section == 'components') {
        docsPageObjFound = true;
        docsPageObj.items.push(docsPageItemObj);
        break;
      }
    }

    // If no corresponding page object found, at a new one
    if(!docsPageObjFound) {
      var docsPageObj = {};
      docsPageObj.category = _category;
      docsPageObj.section = 'components';
      docsPageObj.items = [];
      docsPageObj.items.push(docsPageItemObj);
      docsPagesObj.push(docsPageObj);
    }

    // Write to docs data
    var editedDocsTemplateDataFileObj = JSON.stringify(docsTemplateDataFileObj, null, 2);
    _fs.writeFile(_docsTemplateDataFile, editedDocsTemplateDataFileObj);

    // Add base files
    for(var i = 0; i < fileExtensions.length; i++) {
      var extension = fileExtensions[i];
      if(extension !== '.scss') {

        var filePath;
        switch(extension) {
          case '.njk':
            filePath = _pathTemplate + _namePath;
            break;
          case '.definition.scss':
            filePath = _pathSass + _categoryPath + '/' + _namePath + '/' + _filePrefix + '.' + _namePath;
            break;
          case '.size.scss':
            filePath = _pathSass + _categoryPath + '/' + _namePath + '/' + _filePrefix + '.' + _namePath;
            break;
          case '.js':
            filePath = _pathJs + _jsClassName;
            break;
        }

        var templatePath = _templateFilePrefix + extension;
        var fullFilePath;

        if(extension == '.definition.scss') sassImports.push(_filePrefix + '.' + _namePath + '.definition');
        if(extension == '.size.scss') {
          for (var a = 0; a < _sizes.length; a++) {
            data.sizeName = _sizeNames[a];
            data.sizeIncludeName = _sizeIncludeNames[a];
            data.sizeCssClassName = _sizeCssClassNames[a];
            var sizePath = _sizes[a].toLowerCase();
            fullFilePath = filePath + '.' + sizePath + '.scss';
            sassImports.push(_filePrefix + '.' + _namePath + '.' + sizePath);
            this.fs.copyTpl(this.templatePath(templatePath), this.destinationPath(fullFilePath), data);
          }
        } else {
          fullFilePath = filePath + extension;
          this.fs.copyTpl(this.templatePath(templatePath), this.destinationPath(fullFilePath), data);
        }
      }
    }

    // Add sass config
    var extension = '.scss';
    var templatePath = _templateFilePrefix + extension;
    var filePath = _pathSass + _categoryPath + '/' + _namePath + '/' + _filePrefix + '.' + _namePath;
    var fullFilePath = filePath + extension;
    data.sassImports = '';
    for (var x = 0; x < sassImports.length; x++) {
      data.sassImports += '@import \'' + sassImports[x] + '\';\n';
    }
    this.fs.copyTpl(this.templatePath(templatePath), this.destinationPath(fullFilePath), data);

    this.log('  Adding ' + _name + ' component into the ' + _category + ' category...');

  },

  _delete: function (name) {

    this.log('  Deleting ' + name + ' component from the ' + _category + ' category...');

    // Remove from docs data
    var docsTemplateDataFileObj = JSON.parse(_fs.readFileSync(_docsTemplateDataFile, 'utf8'));
    var docsPagesObj = docsTemplateDataFileObj.docs_pages;
    for (var p = 0; p < docsPagesObj.length; p++) {
      var docsPageObj = docsPagesObj[p];
      if (docsPageObj.category == _category && docsPageObj.section == 'components') {
        // Find matching page items
        var nonMatchingPageItems = [];
        for (var i = 0; i < docsPageObj.items.length; i++) {
          var docsPageItemObj = docsPageObj.items[i];
          if(docsPageItemObj.title !== name) {
            nonMatchingPageItems.push(docsPageItemObj);
          }
        }
        docsPageObj.items = nonMatchingPageItems;
      }
    }

    // Rewrite to docs data
    var editedDocsTemplateDataFileObj = JSON.stringify(docsTemplateDataFileObj, null, 2);
    _fs.writeFileSync(_docsTemplateDataFile, editedDocsTemplateDataFileObj);

    // Delete docs file
    var filePath = _pathTemplate + this._getNamePath(name) + '.njk';
    if(_fs.existsSync(filePath)) {
      _fs.unlinkSync(filePath);
    }

    // Delete sass files
    var filePath = _pathSass + _categoryPath + '/' + this._getNamePath(name) + '/';
    if(_fs.existsSync(filePath)) {
      _fs.readdirSync(filePath).forEach(function(file) {
        var curPath = filePath + file;
        if(_fs.statSync(curPath).isDirectory()) {
          deleteFolderRecursive(curPath);
        } else {
          _fs.unlinkSync(curPath);
        }
      });
      _fs.rmdirSync(filePath);
    }

    // Delete js module
    var filePath = _pathJs + this._getJsClassName(name) + '.js';
    if(_fs.existsSync(filePath)) {
      _fs.unlinkSync(filePath);
    }

  },

  _validateName: function (val) {
    var result = true;
    var regex = new RegExp(/(^[A-za-z]+( ?[A-za-z0-9]+)*$)/);
    if(!val.match(regex)) result = 'Use alphanumeric characters seperated by single spaces. No numbers at start.';
    return result;
  },

  _getName: function (str) {
    var strs = str.toLowerCase().match(/[^\s-]+/g);
    var result = '';
    for(var i = 0; i < strs.length; i++) {
      result += _.upperFirst(strs[i]) + ' ';
    }
    result = result.trim();
    return result;
  },

  _getNamePath: function (str) {
    return str.replace(/\s+/g, '-').toLowerCase();
  },

  _getCssClassName: function (str) {
    var result = this._getName(str);
    return result.replace(/\s+/g, '');
  },

  _getJsClassName: function (str) {
    return this._getCssClassName(str);
  }

}

module.exports = _generator.Base.extend(baseExtension);